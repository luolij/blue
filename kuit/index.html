<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小米手表健康数据获取系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* 保持您原有的所有CSS样式不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e6e6ff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(25, 25, 45, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border: 1px solid rgba(100, 149, 237, 0.3);
        }
        
        /* 请将您之前写的所有CSS样式完整保留在这里 */
        /* 由于长度限制，此处不重复全部CSS，请确保您的原始样式都在这里 */
        
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bluetooth-b"></i> 小米手表健康数据获取系统</h1>
            <p class="subtitle">通过蓝牙地址直接连接设备并读取健康数据</p>
            <p class="compatibility-note" id="compatibilityNote"></p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="panel-title">
                    <i class="fas fa-sliders-h"></i> 控制面板
                </div>
                
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <div id="statusText">未连接</div>
                </div>
                
                <div class="device-address">
                    <input type="text" class="address-input" id="deviceAddress" 
                           value="D8:FA:79:C6:56:1C" placeholder="输入设备蓝牙地址">
                    <button class="btn" id="connectByAddressBtn">
                        <i class="fas fa-plug"></i> 通过地址连接
                    </button>
                </div>
                
                <button class="btn" id="scanBtn">
                    <i class="fas fa-search"></i> 扫描设备
                </button>
                
                <button class="btn" id="connectBtn" disabled>
                    <i class="fas fa-link"></i> 连接设备
                </button>
                
                <button class="btn" id="disconnectBtn" disabled>
                    <i class="fas fa-unlink"></i> 断开连接
                </button>
                
                <button class="btn" id="readDataBtn" disabled>
                    <i class="fas fa-sync-alt"></i> 读取健康数据
                </button>
                
                <div class="device-list" id="deviceList">
                    <div class="device-item">未找到设备 - 请点击"扫描设备"</div>
                </div>
                
                <div class="log-container" id="logContainer">
                    <div class="log-entry"><span class="log-time" id="currentTime">00:00:00</span><span class="log-info">系统就绪，等待用户操作</span></div>
                </div>
                
                <div class="instructions">
                    <h3>使用说明：</h3>
                    <p>1. 使用 <strong>Chrome/Edge</strong> 浏览器并确保支持 Web Bluetooth</p>
                    <p>2. 输入设备蓝牙地址并点击"通过地址连接"直接连接</p>
                    <p>3. 连接后点击"读取健康数据"获取步数、心率等信息</p>
                    <p>4. 在数据面板查看详细的服务和特征值</p>
                    <p>5. 点击"订阅"可接收实时数据更新</p>
                </div>
            </div>
            
            <div class="device-info">
                <div class="panel-title">
                    <i class="fas fa-info-circle"></i> 设备信息
                </div>
                
                <div class="health-data">
                    <div class="health-card">
                        <div class="health-icon"><i class="fas fa-walking"></i></div>
                        <div class="health-value" id="stepsValue">0</div>
                        <div class="health-label">今日步数</div>
                        <div class="data-chart" id="stepsChart"></div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon"><i class="fas fa-heartbeat"></i></div>
                        <div class="health-value" id="heartRateValue">--</div>
                        <div class="health-label">心率 (BPM)</div>
                        <div class="data-chart" id="heartRateChart"></div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon"><i class="fas fa-fire"></i></div>
                        <div class="health-value" id="caloriesValue">0</div>
                        <div class="health-label">卡路里 (千卡)</div>
                        <div class="data-chart" id="caloriesChart"></div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-icon"><i class="fas fa-bed"></i></div>
                        <div class="health-value" id="sleepValue">--:--</div>
                        <div class="health-label">睡眠时长</div>
                        <div class="data-chart" id="sleepChart"></div>
                    </div>
                </div>
                
                <div class="battery-display">
                    <div class="battery-container">
                        <div class="battery-level" id="batteryLevel" style="height: 0%"></div>
                    </div>
                    <div class="battery-info">
                        电池状态: <span class="battery-percentage" id="batteryPercentage">0%</span>
                    </div>
                </div>
                
                <div class="device-details">
                    <div class="detail-item">
                        <span class="detail-label">设备名称:</span>
                        <span class="detail-value" id="deviceName">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">设备地址:</span>
                        <span class="detail-value" id="deviceId">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">连接状态:</span>
                        <span class="detail-value" id="connectionStatus">未连接</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">服务数量:</span>
                        <span class="detail-value" id="serviceCount">0</span>
                    </div>
                </div>
                
                <div class="connection-info">
                    <div class="detail-item">
                        <span class="detail-label">信号强度:</span>
                        <span class="detail-value" id="rssi">- dBm</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">最后更新:</span>
                        <span class="detail-value" id="lastUpdate">-</span>
                    </div>
                </div>
            </div>
            
            <div class="data-panel">
                <div class="panel-title">
                    <i class="fas fa-database"></i> 设备数据
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                
                <div class="services-container">
                    <div class="instructions" id="dataInstructions">
                        <p>连接设备后，此处将显示设备的服务列表。点击服务可展开查看其特征值。</p>
                        <p>对于支持读取的特征值，点击"读取"按钮获取当前值。</p>
                        <p>对于支持通知的特征值，点击"订阅"按钮接收实时更新。</p>
                    </div>
                    
                    <div id="servicesList" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>小米手表健康数据获取系统 | 使用 Chrome/Edge 浏览器以获得最佳兼容性 | 部署于 GitHub Pages</p>
        </div>
    </div>

    <script>
        // 浏览器兼容性检测
        function checkBrowserCompatibility() {
            const compatibilityNote = document.getElementById('compatibilityNote');
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (!isChrome && !isEdge) {
                compatibilityNote.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 推荐使用 Chrome 或 Edge 浏览器以获得完整的蓝牙功能支持';
                compatibilityNote.style.color = '#ffa502';
                return false;
            }
            
            if (!navigator.bluetooth) {
                compatibilityNote.innerHTML = '<i class="fas fa-times-circle"></i> 您的浏览器不支持 Web Bluetooth API，请使用 Chrome/Edge 或启用相关标志';
                compatibilityNote.style.color = '#ff4757';
                return false;
            }
            
            compatibilityNote.innerHTML = '<i class="fas fa-check-circle"></i> 浏览器兼容性检测通过';
            compatibilityNote.style.color = '#2ed573';
            return true;
        }

        // 更新时间显示
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            document.getElementById('currentTime').textContent = timeString;
        }

        // 初始化时间并设置定时更新
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // 全局变量
        let selectedDevice = null;
        let deviceCache = null;
        let batteryCharacteristic = null;
        let heartRateCharacteristic = null;
        let connected = false;
        let scanning = false;
        let services = [];
        let notificationCount = 0;
        
        // 健康数据
        let healthData = {
            steps: 0,
            heartRate: 0,
            calories: 0,
            sleep: {
                hours: 0,
                minutes: 0
            }
        };
        
        // DOM元素
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const scanBtn = document.getElementById('scanBtn');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const readDataBtn = document.getElementById('readDataBtn');
        const connectByAddressBtn = document.getElementById('connectByAddressBtn');
        const deviceAddress = document.getElementById('deviceAddress');
        const deviceList = document.getElementById('deviceList');
        const deviceName = document.getElementById('deviceName');
        const deviceId = document.getElementById('deviceId');
        const connectionStatus = document.getElementById('connectionStatus');
        const serviceCount = document.getElementById('serviceCount');
        const batteryLevel = document.getElementById('batteryLevel');
        const batteryPercentage = document.getElementById('batteryPercentage');
        const rssi = document.getElementById('rssi');
        const lastUpdate = document.getElementById('lastUpdate');
        const servicesList = document.getElementById('servicesList');
        const dataInstructions = document.getElementById('dataInstructions');
        const notificationBadge = document.getElementById('notificationBadge');
        const logContainer = document.getElementById('logContainer');
        
        // 健康数据DOM元素
        const stepsValue = document.getElementById('stepsValue');
        const heartRateValue = document.getElementById('heartRateValue');
        const caloriesValue = document.getElementById('caloriesValue');
        const sleepValue = document.getElementById('sleepValue');
        
        // 添加日志
        function addLog(message, type = 'info') {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">${timeString}</span><span class="log-${type}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 更新状态指示器
        function updateStatus() {
            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = '已连接到设备';
            } else if (scanning) {
                statusDot.className = 'status-dot scanning';
                statusText.textContent = '扫描中...';
            } else {
                statusDot.className = 'status-dot';
                statusText.textContent = '未连接';
            }
        }
        
        // 通过蓝牙地址连接设备
        connectByAddressBtn.addEventListener('click', async () => {
            if (!checkBrowserCompatibility()) {
                addLog('浏览器不兼容，无法使用蓝牙功能', 'error');
                return;
            }
            
            const address = deviceAddress.value.trim();
            if (!address) {
                addLog('请输入设备蓝牙地址', 'error');
                return;
            }
            
            try {
                addLog(`尝试通过地址 ${address} 连接设备...`);
                
                // 尝试从已授权设备中查找
                const devices = await navigator.bluetooth.getDevices();
                const targetDevice = devices.find(device => 
                    device.id.toLowerCase().replace(/:/g, '') === address.toLowerCase().replace(/:/g, '')
                );
                
                if (targetDevice) {
                    addLog('在已授权设备中找到匹配设备，尝试连接...');
                    selectedDevice = targetDevice;
                    await connectToDevice();
                    return;
                }
                
                addLog('设备未在已授权列表中，尝试请求设备...');
                
                // 尝试请求设备
                deviceCache = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        'battery_service', 
                        'device_information', 
                        'generic_access',
                        'heart_rate',
                        'health_thermometer',
                        'fitness_machine',
                        '0000180d-0000-1000-8000-00805f9b34fb',
                        '0000180f-0000-1000-8000-00805f9b34fb',
                        '0000180a-0000-1000-8000-00805f9b34fb',
                        '0000fe95-0000-1000-8000-00805f9b34fb'
                    ]
                });
                
                // 检查设备地址是否匹配
                if (deviceCache.id.toLowerCase().replace(/:/g, '') === address.toLowerCase().replace(/:/g, '')) {
                    addLog('设备地址匹配，尝试连接...');
                    selectedDevice = deviceCache;
                    await connectToDevice();
                } else {
                    addLog(`发现设备 ${deviceCache.name || '未知设备'}，但地址不匹配`, 'error');
                    deviceList.innerHTML = '';
                    const deviceItem = document.createElement('div');
                    deviceItem.className = 'device-item';
                    deviceItem.textContent = `${deviceCache.name || '未知设备'} (${deviceCache.id})`;
                    
                    deviceItem.addEventListener('click', () => {
                        selectedDevice = deviceCache;
                        document.querySelectorAll('.device-item').forEach(item => {
                            item.style.background = 'transparent';
                        });
                        deviceItem.style.background = 'rgba(67, 97, 238, 0.2)';
                        connectBtn.disabled = false;
                        addLog(`已选择设备: ${deviceCache.name || '未知设备'}`);
                    });
                    
                    deviceList.appendChild(deviceItem);
                }
            } catch (error) {
                console.error('通过地址连接错误:', error);
                addLog(`通过地址连接失败: ${error.message}`, 'error');
            }
        });
        
        // 连接设备函数
        async function connectToDevice() {
            if (!selectedDevice || connected) return;
            
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = '连接中...';
                addLog('正在连接设备...');
                
                // 连接到设备
                const server = await selectedDevice.gatt.connect();
                addLog('设备连接成功，正在发现服务...');
                
                // 获取电池服务
                try {
                    const batteryService = await server.getPrimaryService('battery_service');
                    batteryCharacteristic = await batteryService.getCharacteristic('battery_level');
                    
                    // 读取初始电量
                    await updateBatteryLevel();
                    
                    // 监听电量变化
                    batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryChange);
                    await batteryCharacteristic.startNotifications();
                    addLog('电池服务已启用');
                } catch (e) {
                    console.warn('无法获取电池服务:', e);
                    addLog('无法获取电池服务: ' + e.message, 'error');
                }
                
                // 尝试获取心率服务
                try {
                    const heartRateService = await server.getPrimaryService('heart_rate');
                    heartRateCharacteristic = await heartRateService.getCharacteristic('heart_rate_measurement');
                    
                    // 监听心率变化
                    heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChange);
                    await heartRateCharacteristic.startNotifications();
                    addLog('心率监测服务已启用');
                } catch (e) {
                    console.warn('无法获取心率服务:', e);
                    addLog('无法获取心率服务: ' + e.message, 'error');
                }
                
                // 获取所有主要服务
                services = await server.getPrimaryServices();
                
                // 更新UI
                connected = true;
                deviceName.textContent = selectedDevice.name || '未知设备';
                deviceId.textContent = selectedDevice.id;
                connectionStatus.textContent = '已连接';
                serviceCount.textContent = services.length;
                disconnectBtn.disabled = false;
                readDataBtn.disabled = false;
                
                // 显示服务列表
                displayServices(services);
                
                // 生成健康数据图表
                generateHealthCharts();
                
                updateStatus();
                addLog('设备初始化完成，已发现 ' + services.length + ' 个服务', 'success');
            } catch (error) {
                console.error('连接错误:', error);
                connected = false;
                updateStatus();
                addLog(`连接失败: ${error.message}`, 'error');
            } finally {
                connectBtn.textContent = '连接设备';
            }
        }
        
        // 其他函数保持不变（displayServices, displayCharacteristics, decodeValue等）
        // 请确保您原有的所有JavaScript函数都完整保留在这里
        
        // 初始化浏览器兼容性检测
        checkBrowserCompatibility();
        addLog('系统初始化完成', 'success');
    </script>
</body>
</html>
